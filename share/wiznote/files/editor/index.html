<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title></title>
    <script type="text/javascript">
        var UEDITOR_HOME_URL = "./";
    </script>
    <script type="text/javascript" charset="utf-8" src="editor_config.js"></script>
    <script type="text/javascript" charset="utf-8" src="editor_all.js"></script>
    
    <link rel="stylesheet" type="text/css" href="themes/default/ueditor.css"/>
    <style type="text/css">
        .edui-for-mybutton .edui-icon{
            background-position: -480px -20px;
        }
    </style>
</head>
<body>
    <script type="text/plain" id="editorArea"></script>

    <script type="text/javascript">

        var editor = null;
        var modified = false;
        var objApp = WizExplorerApp;
        var objDatabase = objApp.Database;
        var objCommon = objApp.CreateWizObject("WizKMControls.WizCommonUI");
        var currentGUID = "";
        var currentFileName = "";
        var editingDocument = true;

        try {

            var strSave = "Save";
            //
            var saveButton = new baidu.editor.ui.Button({
                className: 'edui-for-mybutton',
                title: strSave,
                label: strSave,
                showText: false,
                onclick: function() {
                    //
                    saveDocument(false);
                    //
                }
            });

            var editorOption = {
            toolbars:
            [
                [saveButton,
                '|',
                'FontFamily', 'FontSize', '|', 'Bold', 'Italic', 'Underline', 'StrikeThrough', '|',
                'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyJustify', '|',
                'Indent', 'Outdent', 'InsertOrderedList', 'InsertUnorderedList', '|',
                'Link', 'ForeColor', 'BackColor', '|', 'RemoveFormat', 'Undo', 'Redo'
                ]
            ],
                elementPathEnabled: false,
                wordCount: false,
                maximumWords: 100000000,
                fullscreen: true
            };
            editor = new baidu.editor.ui.Editor(editorOption);
            editor.render('editorArea');
            editor.addListener('afterexeccommand', onEditorAfterExecCommand);
            editor.addListener('keydown', onEditorKeyDown);
        } catch (err) {
            alert(err);
        }

        function setModified(flag) {
            modified = flag;
            if (!isEditing()) {
                modified = false;
                return;
            }
            objApp.SetDocumentModified(modified);
        }

        function onEditorAfterExecCommand() {
            setModified(true);
        }

        function onEditorKeyDown(type, evt) {
            //
            if (!isEditing())
                return;
            //
            var e = evt;
            if (!e.ctrlKey && !e.altKey && !e.shiftKey) {
                setModified(true);
            }
            if (e.ctrlKey && !e.altKey && !e.shiftKey) {
                if (String.fromCharCode(e.keyCode).toLocaleUpperCase() == 'X') {

                    setModified(true);
                    //
                    e.returnValue = true;
                }
                if (String.fromCharCode(e.keyCode).toLocaleUpperCase() == 'S') {

                    saveDocument(true);
                    //
                    e.returnValue = false;
                }
                else if (String.fromCharCode(e.keyCode).toLocaleUpperCase() == 'V') {
                    if (autoPaste()) {
                        e.returnValue = false;
                        e.keyCode = 0;
                    }
                    else {
                    }
                }
            }
        }

        function isNewDocument() {
            return currentGUID == null || currentGUID == "";
        }

        function setEditorHtml(html) {
            // use setContent can't display images on editor, why?
            editor.setContent(html);
            //editor.document.body.innerHTML = '<p>' + html + '</p>';
            editor.undoManger.reset();
            setModified(false);
			editor.window.scrollTo(0,0);
        }
        
        function getEditorHtml() {
            return editor.getContent();
            //return editor.document.documentElement.outerHTML;
        }

        function setEditorFocus() {
            editor.focus();
            var range = editor.selection.getRange();
            range.select(true);
            editor._selectionChange();
        }

        function isEditing() {
            //return editor.document.body.contentEditable ? true : false;
            return editingDocument;
        }

        function setEditing(editing) {
            if (isEditing()) {
                saveDocument(false);
            }
            if (isEditing() == editing)
                return;

            document.getElementsByClassName("edui-editor-toolbarbox")[0].style.display = editing ? "block" : "none";

            editing ? editor.setEnabled() : editor.setDisabled();
            editingDocument = editing;
            //
            if (editing) {
                setTimeout("setEditorFocus()", 100);
            }
        }
        
        function viewDocument(guid, filename, editing) {
            try {
                currentGUID = guid;
                currentFileName = filename;

                var html = "";
                if (!isNewDocument()) {
                    html = objCommon.LoadTextFromFile(filename);
                }

                // we need wait until ueditor initialized, otherwise 'undefined' error will be fired!
                // maybe it's an issue of ueditor.
                setTimeout(function () {
                    setEditorHtml(html);
                    setEditing(editing);
		}, 50);

                return true;
            }
            catch (err) {
                alert(err);
                return false;
            }
        }

        function updateDocument(objDocument, html, url, falgs) {
            try {
                return objDocument.UpdateDocument4(html, url, falgs);
            }
            catch (err) {
                return false;
            }
        }
        
        function saveDocument(force) {
            try {
                if (!force && !modified)
                    return true;
                if (!isEditing())
                    return true;
                //
                var objFolder = objApp.Window.CategoryCtrl.SelectedFolder;
                if (objFolder == null) {
                    objFolder = objDatabase.GetFolderByLocation("/My Notes/", true);
                }
                if (isNewDocument()) {
                    try {
                        var newDocument = objFolder.CreateDocument2("New Note (" + (new Date()).toLocaleDateString() + ")", "");
                        currentGUID = newDocument.GUID;
                        currentFileName = "";
                    }
                    catch (err) {
                        alert("Can not create a new note!");
                        return false;
                    }
                }
                //
                var objDocument = objDatabase.DocumentFromGUID(currentGUID);
                if (objDocument == null || objDocument == "")
                    return false;
                //
                var html = getEditorHtml();
                //
                objApp.SetSavingDocument(true);
                //
                var ret = updateDocument(objDocument, html, currentFileName, 0);
                //
                objApp.SetSavingDocument(false);
                //
                if (ret) {
                    setModified(false);
                }
                else {
                    alert("Can not save note!");
                }
                return ret;
            }
            catch (err) {
                alert(err);
            }
        }

        function autoPaste() {
            var imageFileName = objCommon.ClipboardToImage(0, "");
            if (imageFileName == null || imageFileName == "")
                return false;
            //
            var html = "<img border=\"0\" src=\"file:///" + imageFileName + "\" />";
            editor.execCommand("inserthtml", html);
            return true;
        }
        
    </script>

</body>


</html>
